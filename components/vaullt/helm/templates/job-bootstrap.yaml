apiVersion: batch/v1
kind: Job
metadata:
  name: vault-bootstrap
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vault-bootstrap
    spec:
      serviceAccountName: vault
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: hashicorp/vault:1.16.3 # TODO pin to desired Vault image
          command: ["/bin/sh","-c"]
          args:
            - >
              apk add --no-cache curl jq gnupg && \
              wget -qO /usr/local/bin/sops https://github.com/getsops/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64 && \
              chmod +x /usr/local/bin/sops && \
              chmod +x /script/bootstrap.sh && \
              /script/bootstrap.sh
          env:
            - name: VAULT_ADDR
              value: "http://vault.vault.svc:8200"
            - name: AGE_PUBLIC_KEY
              value: "{{ .Values.bootstrap.agePublicKey }}"
            - name: KEY_SHARES
              value: "{{ .Values.bootstrap.keyShares | quote }}"
            - name: KEY_THRESHOLD
              value: "{{ .Values.bootstrap.keyThreshold | quote }}"
            - name: ACM_PUSH_URL
              value: "{{ .Values.bootstrap.acmPushURL }}"
            - name: ACM_PUSH_CA_BUNDLE
              valueFrom:
                secretKeyRef:
                  name: vault-bootstrap-acm
                  key: ca.crt
                  optional: true
            - name: ACM_PUSH_AUTH_HEADER
              valueFrom:
                secretKeyRef:
                  name: vault-bootstrap-acm
                  key: authHeader
                  optional: true
          volumeMounts:
            - name: script
              mountPath: /script
            - name: workspace
              mountPath: /workspace
      volumes:
        - name: script
          configMap:
            name: vault-bootstrap-script
            defaultMode: 0755
        - name: workspace
          emptyDir: {}


